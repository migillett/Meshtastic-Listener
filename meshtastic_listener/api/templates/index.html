<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshtastic Listener</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style type="text/css">
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="{{ url_for('static', path='/OpenLayers/OpenLayers.js') }}"></script>

    <script>
        let map
        let layer

        let markersById = new Map();

        function getInitPosition() {
            return fetch('/utils/map_center')
                .then(response => response.json())
                .then(data => {
                    return data;
                })
                .catch(error => {
                    console.error('Error fetching initial position:', error);
                    return {
                        longitude: 0.0,
                        latitude: 0.0
                    };
                });
        }

        async function retrieveAllNodes(limit = 50) {
            let allNodes = [];
            let page = 0;
            let hasMoreData = true;

            while (hasMoreData) {
                try {
                    const data = await fetch(`/nodes/?page=${page}&limit=${limit}`)
                        .then(response => response.json());
                    allNodes = allNodes.concat(data.nodes || []);
                    hasMoreData = data.total > allNodes.length;
                    page++;
                } catch (error) {
                    console.error('Error fetching node positions:', error);
                    hasMoreData = false;
                }
            }
            console.log(`Retrieved ${allNodes.length} nodes`);
            return allNodes;
        }

        async function getTraceroutes() {
            try {
                const tracerouteData = await fetch("/traceroutes/")
                    .then(response => response.json());
                console.log(`Retrieved ${tracerouteData.length} traceroute entries`)
                return tracerouteData;
            } catch (error) {
                console.error('Error fetching traceroute data:', error);
            }
        }

        function retrieveCoordsFromMarker(markerId) {
            let marker = markersById.get(markerId)
            if (marker != null) {
                return marker.getLatLng();
            } else {
                retu
            }
        }

        function drawTraceroutes(tracerouteData) {
            var drawnIds = []
            var polylineCoords = []
            tracerouteData.forEach(tracerouteData => {
                if (!drawnIds.includes(tracerouteData.fromId)) {
                    try {
                        var x1 = markersById.get(tracerouteData.fromId).nodeData;
                        tracerouteData.routeTowards.forEach(nodeNum => {
                            var x2 = markersById.get(nodeNum).nodeData;
                            polylineCoords.push([x1.latitude, x1.longitude], [x2.latitude, x2.longitude])
                            x1 = x2;
                        })
                        console.log(`Added traceroute line for node: ${tracerouteData.fromId} | Hops Towards: ${tracerouteData.routeTowards.length} | Hops Back: ${tracerouteData.routeBack.length}`);
                        drawnIds.push(tracerouteData.fromId);
                    } catch (TypeError) {
                        console.error(`Node id does not have coordinates: ${tracerouteData.fromId}`)
                    }
                }
            })
            var polyLine = L.polyline(polylineCoords, { color: 'blue' }).addTo(map);
        }

        function addMarkersToMap(nodes) {
            let added = 0
            nodes.forEach(node => {
                if (node.latitude && node.longitude) {
                    let markerOptions = {
                        title: node.longName,
                        draggable: false,
                    };
                    var marker = L.marker([node.latitude, node.longitude], markerOptions).addTo(map);
                    marker.addTo(map)
                    marker.bindPopup(`<p>Short Name: ${node.shortName}</br>Long Name: ${node.longName}</br>Role: ${node.nodeRole}</br>Coords: ${node.latitude}, ${node.longitude}</br></p>`);

                    markersById.set(node.nodeNum, { marker: marker, nodeData: node })
                    added++
                }
            });
            console.log(`Successfully ${added} nodes with updated positions to the map`);
        }

        function init() {
            getInitPosition().then(initPosition => {
                console.log('Initializing map with position:', initPosition);
                map = L.map('map').setView([initPosition.latitude, initPosition.longitude], 10);
                layer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                });
                map.addLayer(layer);
            }).catch(error => {
                console.error('Error initializing map:', error);
            });

            retrieveAllNodes().then(nodes => {
                addMarkersToMap(nodes);
                getTraceroutes().then(tracerouteData => {
                    drawTraceroutes(tracerouteData);
                }).catch(error => {
                    console.error(error)
                })
            }).catch(error => {
                console.error(error);
            });
        }

        window.onload = init;
    </script>
</head>

<body>
    <div id="map"></div>
</body>

</html>